define(["./utils"],function(t){function e(e,n){var i,o,r;return n=t.toArray(n),"function"==typeof n[n.length-1]&&(r=n.pop()),"object"==typeof n[n.length-1]&&n.pop(),2==n.length?(i=n[0],o=n[1]):(i=e.node,o=n[0]),{element:i,type:o,callback:r}}function n(t,e){return t.element==e.element&&t.type==e.type&&(null==e.callback||t.callback==e.callback)}function i(){function i(t){this.component=t,this.instances=[],this.addInstance=function(t){this.throwIfInstanceExistsOnNode(t);var e=new o(t);return this.instances.push(e),e},this.throwIfInstanceExistsOnNode=function(t){this.instances.forEach(function(e){if(e.instance.$node[0]===t.$node[0])throw Error("Instance of "+t.constructor+" already exists on node "+t.$node[0])})},this.removeInstance=function(t){var e=this.instances.filter(function(e){return e.instance==t})[0],n=this.instances.indexOf(e);n>-1&&this.instances.splice(n,1),this.instances.length||r.removeComponentInfo(this)}}function o(t){this.instance=t,this.events=[],this.addTrigger=function(){},this.addBind=function(t){this.events.push(t),r.events.push(t)},this.removeBind=function(t){for(var e,i=0;e=this.events[i];i++)n(e,t)&&this.events.splice(i,1)}}var r=this;(this.reset=function(){this.components=[],this.allInstances=[],this.events=[]}).call(this),this.addInstance=function(t){var e=this.findComponentInfo(t);e||(e=new i(t.constructor),this.components.push(e));var n=e.addInstance(t);return this.allInstances.push(n),e},this.removeInstance=function(t){var e,n=this.findInstanceInfo(t),i=this.findComponentInfo(t);i.removeInstance(t);var e=this.allInstances.indexOf(n);e>-1&&this.allInstances.splice(e,1)},this.removeComponentInfo=function(t){var e=this.components.indexOf(t);e>-1&&this.components.splice(e,1)},this.findComponentInfo=function(t){for(var e,n=t.attachTo?t:t.constructor,i=0;e=this.components[i];i++)if(e.component===n)return e;return null},this.findInstanceInfo=function(t){var e;e=t.node?function(e){return e.instance===t}:function(e){return e.instance.node===t};var n=this.allInstances.filter(e);return n.length?t.node?n[0]:n:t.node?null:[]},this.trigger=function(){var t=e(this,arguments),n=r.findInstanceInfo(this);n&&n.addTrigger(t)},this.on=function(n){var i,o=t.toArray(arguments,1),s=r.findInstanceInfo(this);if(s){i=n.apply(null,o),i&&(o[o.length-1]=i);var a=e(this,o);s.addBind(a)}},this.off=function(){var t=e(this,arguments),n=r.findInstanceInfo(this);n&&n.removeBind(t)},this.teardown=function(){r.removeInstance(this)},this.withRegistration=function(){this.before("initialize",function(){r.addInstance(this)}),this.after("trigger",r.trigger),this.around("on",r.on),this.after("off",r.off),this.after("teardown",{obj:r,fnName:"teardown"})}}return new i});